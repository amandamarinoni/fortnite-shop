# --- STAGE 1: Instalação e Geração (BUILDER) ---
FROM node:20-alpine AS builder

# Instala OpenSSL para conexão segura com o PostgreSQL
RUN apk add --no-cache openssl

WORKDIR /usr/src/app

# Copia arquivos de dependência e o schema
COPY package*.json ./
COPY prisma/ ./prisma/

# Instala as dependências
RUN npm install

# Gera o cliente Prisma (tipos e binário Linux)
RUN npx prisma generate

# Copia o restante do código
COPY . .

# Compila o TypeScript para JavaScript
RUN npm run build 


# --- STAGE 2: Produção (RUNNER) ---
FROM node:20-alpine AS runner

WORKDIR /app

# Instala OpenSSL novamente para o Runtime
RUN apk add --no-cache openssl

# Copia apenas o que é essencial para execução:

# Copia node_modules (dependências)
COPY --from=builder /usr/src/app/node_modules ./node_modules

# Copia o código compilado (a pasta dist) e o código fonte
COPY --from=builder /usr/src/app/dist ./dist 
COPY --from=builder /usr/src/app/src ./src

# Copia package.json (para rodar npm start) e prisma/ (para o deploy)
COPY --from=builder /usr/src/app/package*.json ./
COPY --from=builder /usr/src/app/prisma/ ./prisma/

# Comando de inicialização
CMD ["npm", "start"]