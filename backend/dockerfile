FROM node:20-alpine AS build
WORKDIR /usr/src/app
RUN apk add --no-cache openssl libstdc++ bash git build-base

# dentro do contexto backend (package.json est√° aqui)
COPY package*.json ./
RUN if [ -f package-lock.json ]; then npm ci --no-audit --prefer-offline; else npm install --no-audit --prefer-offline; fi

COPY prisma ./prisma
COPY . .
RUN npx prisma generate

FROM node:20-alpine AS runtime
WORKDIR /usr/src/app
RUN apk add --no-cache openssl libstdc++
COPY --from=build /usr/src/app ./
EXPOSE 3000
CMD ["npm","start"]
